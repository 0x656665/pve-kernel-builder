name: Trigger new pve-kernel release check

on:
  workflow_dispatch:
    inputs:
      save-new-version:
        description: 'Save new detected version'
        type: boolean
        default: true
        required: false
  schedule:
    - cron: '45 2 * * *' # Every day at 2:45AM UTC / 7:45PM PST
    - cron: '50 5 * * *'

env:
  DEBIAN_FRONTEND: noninteractive
  SAVE_NEW_VERSION: "${{ inputs.save-new-version != '' && inputs.save-new-version || true }}"

jobs:
  set-state:
    name: Set internal state
    runs-on: ubuntu-latest
    outputs:
      save-new-version: ${{ env.SAVE_NEW_VERSION == 'true' }}
    steps:
      - name: Print state
        run: |
          echo "inputs.save-new-version: ${{ inputs.save-new-version }}"
          echo "SAVE_NEW_VERSION: ${{ env.SAVE_NEW_VERSION }}"
          
  check-for-new-kernel:
    name: Check for new release for each branch
    needs: set-state
    strategy:
      fail-fast: false
      matrix:
        branch: ['master', 'pve-kernel-5.15']
    uses: ./.github/workflows/new-pve-kernel-release-check.yml
    with:
      branch: ${{ matrix.branch }}
      save-new-version: ${{ needs.set-state.outputs.save-new-version }}
    secrets:
      token: ${{ secrets.PAT }}
    permissions:
      contents: write
